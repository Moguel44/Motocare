  const $ = id => document.getElementById(id);
  const getMotos = () => JSON.parse(localStorage.getItem('motos') || '[]');
  const setMotos = m => localStorage.setItem('motos', JSON.stringify(m));
  const getActiva = () => getMotos().find(m => m.id === localStorage.getItem('motoActivaId'));

  function actualizarSelector() {
    const s = $('selectorMoto');
    const motos = getMotos();
    const act = localStorage.getItem('motoActivaId');
    s.innerHTML = motos.map(m => `<option value="${m.id}" ${m.id === act ? 'selected' : ''}>${m.datos.marca} ${m.datos.modelo}</option>`).join('');
  }

  function cargarResumen() {
    const r = $('resumen');
    const m = getActiva();
    if (!m) { r.innerHTML = '<p>No hay moto</p>'; return; }
    r.innerHTML = `<h3>${m.datos.marca} ${m.datos.modelo}</h3>`;
  }

  function mostrar(id) {
    ['home', 'moto', 'mantenimiento', 'historial'].forEach(s => $(s).classList.add('hidden'));
    $(id).classList.remove('hidden');
  }

  function volver() {
    mostrar('home');
    cargarResumen();
  }

  function prepararPdf(){
    const m=getActiva();
    if(!m) return;
    $('pdfMotoDatos').innerText = `${m.datos.marca} ${m.datos.modelo} · ${m.datos.anio||''} · ${m.datos.cilindrada||''}`;
  }

  function generarTextoHistorial(){
    const m=getActiva();
    if(!m) return 'Sin datos';
    let txt=`Moto: ${m.datos.marca} ${m.datos.modelo}\n`;
    (m.historial||[]).forEach((r,i)=>{
      txt+=`\n#${i+1} - ${r.fecha||''} - ${r.km||''} km`;
    });
    return txt;
  }

  $('btnPdf').onclick=()=>{ prepararPdf(); window.print(); };
  $('btnGuardarPdf').onclick=()=>{ prepararPdf(); alert('Elige Guardar como PDF'); window.print(); };
  $('btnEmail').onclick=()=>{
    const body=encodeURIComponent(generarTextoHistorial());
    window.location.href=`mailto:?subject=Historial MotoCare&body=${body}`;
  };

  document.querySelectorAll('.menu button').forEach(b => b.onclick = () => mostrar(b.dataset.target));
  document.querySelectorAll('.volver').forEach(b => b.onclick = volver);

  $('btnNuevaMoto').onclick = () => {
    ['marca','modelo','anio','cilindrada','neumaticos','itv'].forEach(i => $(i).value='');
  };

  $('guardarMoto').onclick = () => {
    if (!$('marca').value) return alert('Marca requerida');
    const motos = getMotos();
    const nueva = {
      id: crypto.randomUUID(),
      datos: {
        marca:$('marca').value,
        modelo:$('modelo').value,
        anio:$('anio').value,
        cilindrada:$('cilindrada').value,
        neumaticos:$('neumaticos').value,
        itv:$('itv').value
      },
      historial: []
    };
    motos.push(nueva);
    setMotos(motos);
    localStorage.setItem('motoActivaId', nueva.id);
    actualizarSelector();
    volver();
  };

  $('selectorMoto').onchange = e => {
    localStorage.setItem('motoActivaId', e.target.value);
    cargarResumen();
  };

  actualizarSelector();
  cargarResumen();
});
</script><!-- NOTA: El registro del Service Worker se elimina aquí para evitar SecurityError
     en entornos restringidos (sandbox, vista previa, algunos navegadores).
     En producción (GitHub Pages / HTTPS real) se debe registrar en un archivo separado. --></body>
</html>
