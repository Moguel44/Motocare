<!DOCTYPE html>
</div>

<div id="historial" class="card hidden">
  <!-- CABECERA PDF (solo impresi贸n) -->
  <div id="pdfHeader" style="display:none;margin-bottom:16px;text-align:center">
    <img src="./Mi_Man.png" alt="MotoCare" style="width:80px;height:80px;border-radius:16px;margin-bottom:8px" />
    <h1 style="margin:0">MotoCare</h1>
    <p id="pdfMotoDatos" style="margin:6px 0 0 0"></p>
  </div>
  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
    <button class="primary" id="btnPdf"> Exportar PDF</button>
    <button class="primary" id="btnGuardarPdf"> Guardar PDF</button>
    <button class="primary" id="btnEmail">锔 Enviar por correo</button>
  </div>
  <h2>Historial</h2>
  <ul id="listaHistorial"></ul>
  <button class="primary volver">Volver</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const $ = id => document.getElementById(id);
  const getMotos = () => JSON.parse(localStorage.getItem('motos') || '[]');
  const setMotos = m => localStorage.setItem('motos', JSON.stringify(m));
  const getActiva = () => getMotos().find(m => m.id === localStorage.getItem('motoActivaId'));

  function actualizarSelector() {
    const s = $('selectorMoto');
    const motos = getMotos();
    const act = localStorage.getItem('motoActivaId');
    s.innerHTML = motos.map(m => `<option value="${m.id}" ${m.id === act ? 'selected' : ''}>${m.datos.marca} ${m.datos.modelo}</option>`).join('');
  }

  function cargarResumen() {
    const r = $('resumen');
    const m = getActiva();
    if (!m) { r.innerHTML = '<p>No hay moto</p>'; return; }
    r.innerHTML = `<h3>${m.datos.marca} ${m.datos.modelo}</h3>`;
  }

  function mostrar(id) {
    ['home', 'moto', 'mantenimiento', 'historial'].forEach(s => $(s).classList.add('hidden'));
    $(id).classList.remove('hidden');
  }

  function volver() {
    mostrar('home');
    cargarResumen();
  }

  function prepararPdf(){
    const m=getActiva();
    if(!m) return;
    $('pdfMotoDatos').innerText = `${m.datos.marca} ${m.datos.modelo} 路 ${m.datos.anio||''} 路 ${m.datos.cilindrada||''}`;
  }

  function generarTextoHistorial(){
    const m=getActiva();
    if(!m) return 'Sin datos';
    let txt=`Moto: ${m.datos.marca} ${m.datos.modelo}
`;
    (m.historial||[]).forEach((r,i)=>{
      txt+=`
#${i+1} - ${r.fecha||''} - ${r.km||''} km`;
    });
    return txt;
  }

  $('btnPdf') && ($('btnPdf').onclick=()=>{
    prepararPdf();
    if(typeof window.print === 'function'){
      try{ window.print(); }
      catch(e){ alert('La impresi贸n no est谩 soportada en esta app. Usa la versi贸n web.'); }
    } else {
      alert('La impresi贸n no est谩 soportada en esta app. Usa la versi贸n web.');
    }
  });

  // Guardar PDF (usa di谩logo nativo de Android / navegador)
  $('btnGuardarPdf') && ($('btnGuardarPdf').onclick=()=>{
    prepararPdf();
    if(typeof window.print === 'function'){
      alert('Se abrir谩 el di谩logo del sistema. Elige "Guardar como PDF".');
      try{ window.print(); }
      catch(e){ alert('Guardar PDF no est谩 soportado en esta app. Usa la versi贸n web.'); }
    } else {
      alert('Guardar PDF no est谩 soportado en esta app. Usa la versi贸n web.');
    }
  });
  $('btnEmail') && ($('btnEmail').onclick=()=>{
    const body=encodeURIComponent(generarTextoHistorial());
    const url=`mailto:?subject=Historial MotoCare&body=${body}`;
    try{ window.location.href=url; }
    catch(e){ alert('El env铆o por correo no est谩 soportado en esta app. Usa la versi贸n web.'); }
  });

  document.querySelectorAll('.menu button').forEach(b => b.onclick = () => mostrar(b.dataset.target));
  document.querySelectorAll('.volver').forEach(b => b.onclick = volver);

  $('btnNuevaMoto').onclick = () => {
    ['marca', 'modelo', 'anio', 'cilindrada', 'neumaticos', 'itv'].forEach(i => $(i).value = '');
  };

  $('guardarMoto').onclick = () => {
    if (!$('marca').value) return alert('Marca requerida');
    const motos = getMotos();
    const nueva = {
      id: crypto.randomUUID(),
      datos: {
        marca: $('marca').value,
        modelo: $('modelo').value,
        anio: $('anio').value,
        cilindrada: $('cilindrada').value,
        neumaticos: $('neumaticos').value,
        itv: $('itv').value
      },
      historial: []
    };
    motos.push(nueva);
    setMotos(motos);
    localStorage.setItem('motoActivaId', nueva.id);
    actualizarSelector();
    volver();
  };

  $('selectorMoto').onchange = e => {
    localStorage.setItem('motoActivaId', e.target.value);
    cargarResumen();
  };

  actualizarSelector();
  cargarResumen();
});
</script>
</body>
</html>
